<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minecraft Dialogue Generator (Fixed Syntax Edition)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen">
  <div class="container mx-auto p-4 max-w-4xl">
    <h1 class="text-3xl font-bold text-center mb-6">Minecraft Dialogue Generator (Fixed Syntax Edition)</h1>
    
    <div class="mb-6">
      <button onclick="showTab('characters')" class="bg-blue-500 text-white px-4 py-2 rounded-md mr-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏</button>
      <button onclick="showTab('dialogue')" class="bg-blue-500 text-white px-4 py-2 rounded-md">–°–æ–∑–¥–∞—Ç—å –¥–∏–∞–ª–æ–≥</button>
    </div>

    <div id="characters-tab" class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
        <input id="new-character-name" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä | Villager1">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
        <select id="new-character-color" class="mt-1 block w-full p-2 border rounded-md">
          <option value="green">–ó–µ–ª—ë–Ω—ã–π</option>
          <option value="yellow">–ñ—ë–ª—Ç—ã–π</option>
          <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
          <option value="blue">–°–∏–Ω–∏–π</option>
          <option value="white">–ë–µ–ª—ã–π</option>
        </select>
      </div>
      <button onclick="addCharacter()" class="bg-green-500 text-white px-4 py-2 rounded-md">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
      <div id="character-list" class="mt-4 space-y-2"></div>
    </div>

    <div id="dialogue-tab" class="bg-white p-6 rounded-lg shadow-md hidden">
      <h2 class="text-xl font-semibold mb-4">–°–æ–∑–¥–∞—Ç—å –¥–∏–∞–ª–æ–≥</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">–í–µ—Ä—Å–∏—è Minecraft</label>
        <select id="minecraft-version" class="mt-1 block w-full p-2 border rounded-md">
          <option value="1.12">1.12</option>
          <option value="1.13-1.19">1.13‚Äì1.19</option>
          <option value="1.20+" selected>1.20+</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ Scoreboard</label>
        <input id="scoreboard-name" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä | Dialog" value="Dialog">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ Scoreboard –¥–ª—è —Å—é–∂–µ—Ç–∞</label>
        <input id="plot-scoreboard" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä | PlotPoints" value="PlotPoints">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Namespace –¥–∞—Ç–∞–ø–∞–∫–∞</label>
        <input id="namespace" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä | dialog" value="dialog">
      </div>
      <div id="lines" class="space-y-4"></div>
      <button onclick="addLine()" class="bg-green-500 text-white px-4 py-2 rounded-md mt-4">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–ø–ª–∏–∫—É</button>
      <button onclick="generateDialogue()" class="bg-blue-500 text-white px-4 py-2 rounded-md mt-4 ml-2">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã</button>
    </div>

    <div id="output" class="bg-white p-6 rounded-lg shadow-md hidden">
      <h2 class="text-xl font-semibold mb-4">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h2>
      <div id="files" class="space-y-4"></div>
      <button onclick="downloadAll()" class="bg-purple-500 text-white px-4 py-2 rounded-md mt-4">–°–∫–∞—á–∞—Ç—å –≤—Å–µ (.zip)</button>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
          <input id="edit-character-name" type="text" class="mt-1 block w-full p-2 border rounded-md">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
          <select id="edit-character-color" class="mt-1 block w-full p-2 border rounded-md">
            <option value="green">–ó–µ–ª—ë–Ω—ã–π</option>
            <option value="yellow">–ñ—ë–ª—Ç—ã–π</option>
            <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
            <option value="blue">–°–∏–Ω–∏–π</option>
            <option value="white">–ë–µ–ª—ã–π</option>
          </select>
        </div>
        <button onclick="saveCharacterEdit()" class="bg-green-500 text-white px-4 py-2 rounded-md">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="closeModal()" class="bg-red-500 text-white px-4 py-2 rounded-md ml-2">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    let characters = [];
    let editIndex = null;

    function showTab(tab) {
      document.getElementById('characters-tab').classList.add('hidden');
      document.getElementById('dialogue-tab').classList.add('hidden');
      document.getElementById(`${tab}-tab`).classList.remove('hidden');
    }

    function updateCharacterList() {
      const list = document.getElementById('character-list');
      list.innerHTML = '';
      characters.forEach((char, index) => {
        const div = document.createElement('div');
        div.className = 'flex space-x-2 items-center';
        div.innerHTML = `
          <span class="flex-1">${char.name} (${char.color})</span>
          <button onclick="openEditModal(${index})" class="bg-yellow-500 text-white px-2 py-1 rounded-md">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button onclick="deleteCharacter(${index})" class="bg-red-500 text-white px-2 py-1 rounded-md">–£–¥–∞–ª–∏—Ç—å</button>
        `;
        list.appendChild(div);
      });
      updateCharacterSelects();
    }

    function addCharacter() {
      const name = document.getElementById('new-character-name').value.trim();
      const color = document.getElementById('new-character-color').value;
      if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!');
        return;
      }
      characters.push({ name, color });
      document.getElementById('new-character-name').value = '';
      updateCharacterList();
    }

    function openEditModal(index) {
      editIndex = index;
      document.getElementById('edit-character-name').value = characters[index].name;
      document.getElementById('edit-character-color').value = characters[index].color;
      document.getElementById('edit-modal').classList.remove('hidden');
    }

    function saveCharacterEdit() {
      const name = document.getElementById('edit-character-name').value.trim();
      const color = document.getElementById('edit-character-color').value;
      if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!');
        return;
      }
      characters[editIndex] = { name, color };
      closeModal();
      updateCharacterList();
    }

    function closeModal() {
      document.getElementById('edit-modal').classList.add('hidden');
      editIndex = null;
    }

    function deleteCharacter(index) {
      if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ${characters[index].name}?`)) {
        characters.splice(index, 1);
        updateCharacterList();
      }
    }

    function updateCharacterSelects() {
      const selects = document.querySelectorAll('.line-character, .choice-followup-character');
      selects.forEach(select => {
        const current = select.value;
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</option>' + 
          characters.map(c => `<option value="${c.name}" ${c.name === current ? 'selected' : ''}>${c.name}</option>`).join('');
      });
    }

    function addChoice(button) {
      const choiceDiv = document.createElement('div');
      choiceDiv.className = 'choice bg-white p-2 border rounded-md';
      choiceDiv.innerHTML = `
        <div class="flex space-x-2 mb-2">
          <input type="text" class="choice-text flex-1 p-2 border rounded-md" placeholder="–¢–µ–∫—Å—Ç –≤—ã–±–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä | [–î–∞])">
          <input type="text" class="choice-function flex-1 p-2 border rounded-md" placeholder="–§—É–Ω–∫—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä | yes)">
          <select class="choice-color p-2 border rounded-md">
            <option value="blue">–°–∏–Ω–∏–π</option>
            <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
            <option value="green">–ó–µ–ª—ë–Ω—ã–π</option>
          </select>
          <input type="number" class="choice-plot-points w-24 p-2 border rounded-md" placeholder="–û—á–∫–∏ —Å—é–∂–µ—Ç–∞" value="0">
        </div>
        <div class="mb-2">
          <label class="block text-sm font-medium text-gray-700">–†–µ–ø–ª–∏–∫–∞ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞</label>
          <input type="text" class="choice-followup mt-1 block w-full p-2 border rounded-md" placeholder="–¢–µ–∫—Å—Ç —Å–ª–µ–¥—É—é—â–µ–π —Ä–µ–ø–ª–∏–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
          <select class="choice-followup-character mt-1 block w-full p-2 border rounded-md">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>
            ${characters.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
          </select>
        </div>
        <button onclick="this.parentElement.remove(); updateTransitionState(this.parentElement.parentElement)" class="bg-red-500 text-white px-2 py-1 rounded-md">–£–¥–∞–ª–∏—Ç—å</button>
      `;
      button.parentElement.querySelector('.choices').appendChild(choiceDiv);
      updateTransitionState(button.parentElement);
    }

    function addLine() {
      const linesDiv = document.getElementById('lines');
      const lineDiv = document.createElement('div');
      lineDiv.className = 'line bg-gray-50 p-4 rounded-md';
      lineDiv.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-lg font-medium">–†–µ–ø–ª–∏–∫–∞</h3>
          <button onclick="this.parentElement.parentElement.remove(); updateAllTransitionStates()" class="bg-red-500 text-white px-2 py-1 rounded-md">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
        <div class="mb-2">
          <label class="block text-sm font-medium text-gray-700">–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
          <select class="line-character mt-1 block w-full p-2 border rounded-md">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</option>
            ${characters.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
          </select>
        </div>
        <div class="mb-2">
          <label class="block text-sm font-medium text-gray-700">–¢–µ–∫—Å—Ç —Ä–µ–ø–ª–∏–∫–∏</label>
          <input type="text" class="line-text mt-1 block w-full p-2 border rounded-md" placeholder="–¢–µ–∫—Å—Ç —Ä–µ–ø–ª–∏–∫–∏">
        </div>
        <div class="mb-2">
          <label class="block text-sm font-medium text-gray-700">–¢–∏–ø –ø–µ—Ä–µ—Ö–æ–¥–∞</label>
          <select class="line-transition mt-1 block w-full p-2 border rounded-md">
            <option value="delay">–ó–∞–¥–µ—Ä–∂–∫–∞</option>
            <option value="button">–ö–Ω–æ–ø–∫–∞ [–î–∞–ª–µ–µ]</option>
            <option value="none">–ù–µ—Ç (–ø—Ä–∏ –≤—ã–±–æ—Ä–µ)</option>
          </select>
        </div>
        <div class="mb-2 delay-field">
          <label class="block text-sm font-medium text-gray-700">–ó–∞–¥–µ—Ä–∂–∫–∞ (—Ç–∏–∫–∏)</label>
          <input type="number" class="line-delay mt-1 w-24 p-2 border rounded-md" placeholder="–¢–∏–∫–∏" value="100">
        </div>
        <div class="mb-2 plot-condition">
          <label class="block text-sm font-medium text-gray-700">–£—Å–ª–æ–≤–∏–µ –ø–æ —Å—é–∂–µ—Ç–Ω—ã–º –æ—á–∫–∞–º</label>
          <select class="plot-condition-type mt-1 w-32 p-2 border rounded-md">
            <option value="none">–ù–µ—Ç</option>
            <option value="min">>=</option>
            <option value="max"><=</option>
            <option value="exact">==</option>
          </select>
          <input type="number" class="plot-condition-value mt-1 w-24 p-2 border rounded-md" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" value="0">
        </div>
        <div class="choices mt-2 space-y-2"></div>
        <button onclick="addChoice(this)" class="bg-blue-500 text-white px-2 py-1 rounded-md mt-2">–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä</button>
      `;
      linesDiv.appendChild(lineDiv);
      lineDiv.querySelector('.line-transition').addEventListener('change', function() {
        const delayField = this.parentElement.parentElement.querySelector('.delay-field');
        delayField.classList.toggle('hidden', this.value !== 'delay');
      });

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º MutationObserver –≤–º–µ—Å—Ç–æ DOMSubtreeModified
      const choicesDiv = lineDiv.querySelector('.choices');
      const observer = new MutationObserver(() => updateTransitionState(lineDiv));
      observer.observe(choicesDiv, { childList: true });
      updateAllTransitionStates();
    }

    function updateTransitionState(lineElement) {
      const choices = lineElement.querySelector('.choices').children.length > 0;
      const transitionSelect = lineElement.querySelector('.line-transition');
      const delayField = lineElement.querySelector('.delay-field');
      if (choices) {
        transitionSelect.value = 'none';
        transitionSelect.disabled = true;
        delayField.classList.add('hidden');
      } else {
        transitionSelect.disabled = false;
        if (transitionSelect.value === 'delay') delayField.classList.remove('hidden');
        else delayField.classList.add('hidden');
      }
    }

    function updateAllTransitionStates() {
      document.querySelectorAll('.line').forEach(updateTransitionState);
    }

    function generateDialogue() {
  try {
    console.log('üß† –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–∞–ª–æ–≥–∞...');

    // üîß –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    const version = document.getElementById('minecraft-version').value;
    const scoreboard = document.getElementById('scoreboard-name').value.trim() || 'Dialog';
    const plotScoreboard = document.getElementById('plot-scoreboard').value.trim() || 'PlotPoints';
    const namespace = document.getElementById('namespace').value.trim() || 'dialog';

    // üß© –°–±–æ—Ä —Ä–µ–ø–ª–∏–∫
    const lines = Array.from(document.querySelectorAll('.line')).map((line) => {
      const characterName = line.querySelector('.line-character').value;
      const character = characters.find(c => c.name === characterName) || { name: '', color: 'white' };
      const text = line.querySelector('.line-text').value.trim();
      const transition = line.querySelector('.line-transition').value;
      const delay = parseInt(line.querySelector('.line-delay').value || '100');
      const plotType = line.querySelector('.plot-condition-type').value;
      const plotValue = parseInt(line.querySelector('.plot-condition-value').value || '0');

      const choices = Array.from(line.querySelectorAll('.choice')).map(choice => {
        const choiceText = choice.querySelector('.choice-text').value.trim();
        const choiceFunc = choice.querySelector('.choice-function').value.trim();
        const choiceColor = choice.querySelector('.choice-color').value;
        const plotPoints = parseInt(choice.querySelector('.choice-plot-points').value || '0');
        const followText = choice.querySelector('.choice-followup').value.trim();
        const followCharName = choice.querySelector('.choice-followup-character').value;
        const followChar = characters.find(c => c.name === followCharName) || { name: '', color: 'white' };

        return {
          text: choiceText,
          function: choiceFunc,
          color: choiceColor,
          plotPoints,
          followup: {
            text: followText,
            character: followChar
          }
        };
      });

      return {
        character,
        text,
        transition,
        delay,
        plotCondition: { type: plotType, value: plotValue },
        choices
      };
    });

    // üßº –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (lines.length === 0) throw new Error('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ä–µ–ø–ª–∏–∫—É!');
    lines.forEach((line, i) => {
      if (!line.character.name) throw new Error(`–†–µ–ø–ª–∏–∫–∞ ${i + 1}: –≤—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞`);
      if (!line.text) throw new Error(`–†–µ–ø–ª–∏–∫–∞ ${i + 1}: –≤–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç`);
      line.choices.forEach((choice, j) => {
        if (!choice.text) throw new Error(`–†–µ–ø–ª–∏–∫–∞ ${i + 1}, –≤—ã–±–æ—Ä ${j + 1}: –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞`);
        if (!choice.function) throw new Error(`–†–µ–ø–ª–∏–∫–∞ ${i + 1}, –≤—ã–±–æ—Ä ${j + 1}: –Ω–µ—Ç –∏–º–µ–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏`);
        if (choice.followup.text && !choice.followup.character.name) {
          throw new Error(`–†–µ–ø–ª–∏–∫–∞ ${i + 1}, –≤—ã–±–æ—Ä ${j + 1}: –≤—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Ä–µ–ø–ª–∏–∫–∏`);
        }
      });
    });

    // üì¶ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
    let mainCommands = `# üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è\n`;
    mainCommands += `scoreboard objectives add ${scoreboard} dummy\n`;
    mainCommands += `scoreboard objectives add ${plotScoreboard} dummy\n`;
    if (version === '1.12') mainCommands += `scoreboard objectives add DialogTimer dummy\n`;

    mainCommands += `\n# üöÄ –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è\n`;
    mainCommands += (version === '1.12')
      ? `scoreboard players set @a ${scoreboard} 0\nscoreboard players set @a ${plotScoreboard} 0\nscoreboard players set @a DialogTimer 0\n`
      : `scoreboard players set @a[limit=1] ${scoreboard} 0\nscoreboard players set @a[limit=1] ${plotScoreboard} 0\n`;

    let stage = 1;
    let choiceFunctions = {};
    let convergencePoints = [];

    lines.forEach((line, i) => {
      const cond = (line.plotCondition.type === 'none') ? '' : (() => {
        const val = line.plotCondition.value;
        if (version === '1.12') {
          if (line.plotCondition.type === 'min') return ` if entity @a[score_${plotScoreboard}_min=${val}]`;
          if (line.plotCondition.type === 'max') return ` if entity @a[score_${plotScoreboard}=${val}]`;
          if (line.plotCondition.type === 'exact') return ` if entity @a[score_${plotScoreboard}=${val},score_${plotScoreboard}_min=${val}]`;
        } else {
          if (line.plotCondition.type === 'min') return ` if score @a[limit=1] ${plotScoreboard} matches ${val}..`;
          if (line.plotCondition.type === 'max') return ` if score @a[limit=1] ${plotScoreboard} matches ..${val}`;
          if (line.plotCondition.type === 'exact') return ` if score @a[limit=1] ${plotScoreboard} matches ${val}`;
        }
        return '';
      })();

      // üó®Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ
      mainCommands += `# –†–µ–ø–ª–∏–∫–∞ ${stage}: ${line.character.name}\n`;
      const message = `{"text":"[${line.character.name}] ${line.text.replace(/"/g, '\\"')}","color":"${line.character.color}"}`;
      mainCommands += (version === '1.12')
        ? `execute @a[score_${scoreboard}_min=${stage},score_${scoreboard}=${stage}] ~ ~ ~ tellraw @a ${message}\n`
        : `execute${cond} if score @a[limit=1] ${scoreboard} matches ${stage} run tellraw @a[limit=1] ${message}\n`;

      // üéØ –í—ã–±–æ—Ä—ã
      if (line.choices.length > 0) {
        mainCommands += (version === '1.12')
          ? `execute @a[score_${scoreboard}_min=${stage},score_${scoreboard}=${stage}] ~ ~ ~ tellraw @a [`
          : `execute${cond} if score @a[limit=1] ${scoreboard} matches ${stage} run tellraw @a[limit=1] [`;

        line.choices.forEach((choice, ci) => {
          mainCommands += `{"text":"${choice.text}","color":"${choice.color}","clickEvent":{"action":"run_command","value":"/function ${namespace}:${choice.function}"}}`;
          if (ci < line.choices.length - 1) mainCommands += ',';

          let funcBody = `# –í—ã–±–æ—Ä: ${choice.text}\n`;
          if (choice.plotPoints !== 0) {
            funcBody += (version === '1.12')
              ? `scoreboard players add @a ${plotScoreboard} ${choice.plotPoints}\n`
              : `scoreboard players add @a[limit=1] ${plotScoreboard} ${choice.plotPoints}\n`;
          }
          const nextStage = stage + ci + 1;
          funcBody += (version === '1.12')
            ? `scoreboard players set @a ${scoreboard} ${nextStage}\n`
            : `scoreboard players set @a[limit=1] ${scoreboard} ${nextStage}\n`;

          if (choice.followup.text) {
            const msg = `{"text":"[${choice.followup.character.name}] ${choice.followup.text.replace(/"/g, '\\"')}","color":"${choice.followup.character.color}"}`;
            funcBody += (version === '1.12')
              ? `tellraw @a ${msg}\nscoreboard players set @a DialogTimer ${line.delay}\n`
              : `tellraw @a[limit=1] ${msg}\nschedule function ${namespace}:dialog ${line.delay}t\n`;
          }

          choiceFunctions[choice.function] = funcBody;
        });

        mainCommands += `]\n`;
        convergencePoints.push({ after: stage + line.choices.length, from: stage });
        stage += line.choices.length;
      } else {
        if (i < lines.length - 1) {
          if (line.transition === 'button') {
            mainCommands += (version === '1.12')
              ? `execute @a[score_${scoreboard}_min=${stage},score_${scoreboard}=${stage}] ~ ~ ~ tellraw @a {"text":"[–î–∞–ª–µ–µ]","color":"gray","clickEvent":{"action":"run_command","value":"/function ${namespace}:next"}}\n`
              : `execute${cond} if score @a[limit=1] ${scoreboard} matches ${stage} run tellraw @a[limit=1] {"text":"[–î–∞–ª–µ–µ]","color":"gray","clickEvent":{"action":"run_command","value":"/function ${namespace}:next"}}\n`;
          } else if (line.transition === 'delay') {
            mainCommands += (version === '1.12')
              ? `scoreboard players set @a DialogTimer ${line.delay}\n`
              : `schedule function ${namespace}:next ${line.delay}t\n`;
          }
          stage++;
        }
      }
    });

    // üßº –°–±—Ä–æ—Å
    mainCommands += `\n# üîÅ –°–±—Ä–æ—Å\n`;
    mainCommands += (version === '1.12')
      ? `execute @a[score_${scoreboard}_min=${stage},score_${scoreboard}=${stage}] ~ ~ ~ scoreboard players set @a ${scoreboard} 0\n`
      : `execute if score @a[limit=1] ${scoreboard} matches ${stage} run scoreboard players set @a[limit=1] ${scoreboard} 0\n`;

    if (version === '1.12') {
      mainCommands += `\n# ‚è≤Ô∏è –¢–∞–π–º–µ—Ä\n`;
      mainCommands += `scoreboard players remove @a[score_DialogTimer_min=1] DialogTimer 1\n`;
      mainCommands += `execute @a[score_${scoreboard}_min=1..999,score_DialogTimer=0] ~ ~ ~ scoreboard players add @a ${scoreboard} 1\n`;
    }

    // üß¨ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ
    const files = {
      'dialog.mcfunction': mainCommands,
      'next.mcfunction': nextFunction,
      ...Object.fromEntries(Object.entries(choiceFunctions).map(([k, v]) => [`${k}.mcfunction`, v]))
    };

    // üìã –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const filesDiv = document.getElementById('files');
    filesDiv.innerHTML = '';
    Object.entries(files).forEach(([name, content]) => {
      const fileDiv = document.createElement('div');
      fileDiv.innerHTML = `
        <h3 class="text-lg font-semibold">${name}</h3>
        <pre class="bg-gray-100 p-4 rounded-md overflow-x-auto">${content}</pre>
        <button onclick="copyText(this)" class="bg-green-500 text-white px-4 py-2 rounded-md mt-2">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      `;
      filesDiv.appendChild(fileDiv);
    });

    document.getElementById('output').classList.remove('hidden');
    window.generatedFiles = files;
    window.version = version;
    window.namespace = namespace;

    alert('‚úÖ –ö–æ–º–∞–Ω–¥—ã —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã!');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error);
    alert(`–û—à–∏–±–∫–∞: ${error.message}. –ó–∞–≥–ª—è–Ω–∏ –≤ –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.`);
  }
}


    function copyText(button) {
      try {
        const pre = button.previousElementSibling;
        navigator.clipboard.writeText(pre.textContent).then(() => {
          alert('–ö–æ–º–∞–Ω–¥—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.');
      }
    }

    function downloadAll() {
      try {
        const zip = new JSZip();
        const version = window.version || '1.20+';
        const namespace = window.namespace || 'dialog';
        const functionFolder = version === '1.20+' ? 'function' : 'functions';
        const tagFolder = version === '1.20+' ? 'tag' : 'tags';
        const packFormat = version === '1.12' ? 3 : version === '1.13-1.19' ? 6 : 10;

        Object.entries(window.generatedFiles).forEach(([name, content]) => {
          zip.file(`data/${namespace}/${functionFolder}/${name}`, content);
        });
        zip.file(`data/${namespace}/${tagFolder}/functions/tick.json`, JSON.stringify({ values: [`${namespace}:dialog`] }));
        zip.file('pack.mcmeta', JSON.stringify({
          pack: { pack_format: packFormat, description: 'Dialogue Datapack' }
        }, null, 2));
        zip.generateAsync({ type: 'blob' }).then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'dialog_datapack.zip';
          a.click();
          URL.revokeObjectURL(url);
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ ZIP:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ ZIP-–∞—Ä—Ö–∏–≤–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.');
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞
    console.log('–°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, —Ñ—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã.');

    updateCharacterList();
    addLine();
  </script>
</body>
</html>
